---
title: "term7-project"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```
```{r}
#Load in the data
loans <- read.csv('prosperLoanData.csv', na.strings = '')
library(ggplot2)
library(dplyr)

```
## Exploring the data

Here we will explore the data and choose some variables to examine in further depth.
```{r}
colnames(loans)

table(loans$LoanStatus)

table(loans$CreditGrade)
#Here I find that many of the credit grade (and prosper equivalent)
#Ratings are "". I want to combine them to get rid of this. I will
#do this in a little bit.
```
I feel that the most interesting investigation into this data would be attempting to predict whether or not a loan defaults. This is obviously a tough thing, so I will first begin by examining the characteristics of defaulted loans versus completed ones.

The first things I am going to look at are credit grade and employment status. I expect that loans that default will have a lower credit grade and/or a more precarious employment status.

By reading the documentation it is clear that loans post-January 2009 have a Prosper Rating while those before have a credit grade. Therefore I am going to combine them into one varable called 'Rating'.
```{r}
loans$Rating <- ifelse(is.na(loans$CreditGrade),
                       as.character(loans$ProsperRating..Alpha.),
                       as.character(loans$CreditGrade))

loans$Rating = factor(loans$Rating, 
                      c('AA', 'A', 'B', 'C', 'D', 'E', 'HR', 'NC'))
```
Now lets subset our data.
```{r}
defaults <- subset(loans, LoanStatus == 'Defaulted')
completed <- subset(loans, LoanStatus == 'Completed')
```

Now let's look.
```{r}
ggplot(aes(x = Rating), data = defaults) +
  geom_bar()
```
```{r}
ggplot(aes(x = Rating), data = completed) +
  geom_bar()

```
We notice something interesting from these graphs. As expected, the defaulted loans have ratings toward the lower end. However, the completed loans don't seem to favor one rating vs. another. Now let's look at employment status.
```{r}
ggplot(aes(x = EmploymentStatus), data = defaults) +
  geom_bar()

```
```{r}
ggplot(aes(x = EmploymentStatus), data = completed) +
  geom_bar()
```
We can see from the above that there isn't too much a difference in employment status, though the defaults seem to have more 'not available' than the completed. Now let's look at some quantitative variables, namely, credit score of the borrower. We will first average the upper and lower credit scores.
```{r}
#Don't forget to add this to the subsets too
loans$CreditScoreAvg <- (loans$CreditScoreRangeLower + loans$CreditScoreRangeUpper) / 2

defaults <- subset(loans, LoanStatus == 'Defaulted')
completed <- subset(loans, LoanStatus == 'Completed')

ggplot(aes(x = CreditScoreAvg), data = defaults) +
  geom_histogram(binwidth = 19)
```
```{r}
ggplot(aes(x = CreditScoreAvg), data = completed) +
  geom_histogram(binwidth = 19)
```
```{r}
mean(subset(defaults, !is.na(CreditScoreAvg))$CreditScoreAvg)

mean(subset(completed, !is.na(CreditScoreAvg))$CreditScoreAvg)
```
So we can see from above that the defaults have a lower mean credit score than the completed, which is what we would expect. Now let's look at month income.
```{r}
ggplot(aes(x = StatedMonthlyIncome), data = defaults) +
  geom_histogram() +
  scale_x_continuous(breaks = seq(0, 20000, 1000), limits = c(0, 20000))
```
```{r}
ggplot(aes(x = StatedMonthlyIncome), data = completed) +
  geom_histogram() +
  scale_x_continuous(breaks = seq(0, 20000, 1000), limits = c(0, 20000))
```
Because these are both very long-tailed distributions, let's look at the median.
```{r}
median(subset(defaults, !is.na(StatedMonthlyIncome))$StatedMonthlyIncome)

median(subset(completed, !is.na(StatedMonthlyIncome))$StatedMonthlyIncome)
```
Again, we see that the median monthly income for the completed loans is higher than that of the defaults. Soon we can start building a model to try and predict the probability a loan will default. Next let us look at debt to income ratio.
```{r}
ggplot(aes(x = DebtToIncomeRatio), data = defaults) +
  geom_histogram() +
  scale_x_continuous(breaks = seq(0, 1, .1), limits = c(0, 1))
```
```{r}
ggplot(aes(x = DebtToIncomeRatio), data = completed) +
  geom_histogram() +
  scale_x_continuous(breaks = seq(0, 1, .1), limits = c(0, 1))
```
Again, since they are long-tailed, let's look at the median.
```{r}
median(subset(defaults, !is.na(DebtToIncomeRatio))$DebtToIncomeRatio)

median(subset(completed, !is.na(DebtToIncomeRatio))$DebtToIncomeRatio)
```
We can see that, once again, the completed loans have a lower debt-to-income ratio than the defaulted loans, this too makes sense.

## Recap so Far

We have found a few interesting things that can help our model. First, defaulted loans tend to have lower ratings than completed loans. Second, the employment status of the borrower doesn't seem to matter as much, though defaulted loans had higher instances of 'not available'. Third, the mean credit scores and median monthly income of defaulted loans is less than completed loans. Finally, the median debt-to-income ratio is higher for defaulted loans.

We are going to look at a few more variables. First, the APR of the loan. Second, the number of open credit lines. Third, whether or not the borrower provided verifiable documentation of income. And fourth, the bank card utilization of the borrower.
```{r}
ggplot(aes(x = BorrowerAPR), data = defaults) +
  geom_histogram(binwidth = .01) +
  scale_x_continuous(breaks = seq(0, .5, .05))
```
```{r}
ggplot(aes(x = BorrowerAPR), data = completed) +
  geom_histogram(binwidth = .01) +
  scale_x_continuous(breaks = seq(0, .5, .05))
```
Let's take a look at the median now.
```{r}
median(subset(defaults, !is.na(BorrowerAPR))$BorrowerAPR)

median(subset(completed, !is.na(BorrowerAPR))$BorrowerAPR)
```
We see here that the defaulted loans tend to have a higher APR than the completed loans. Let's look through the other variables.
```{r}
ggplot(aes(x = OpenCreditLines), data = defaults) +
  geom_histogram(binwidth = 1)
```
```{r}
ggplot(aes(x = OpenCreditLines), data = completed) +
  geom_histogram(binwidth = 1)
```
And again, the medians.
```{r}
median(subset(defaults, !is.na(OpenCreditLines))$OpenCreditLines)

median(subset(completed, !is.na(OpenCreditLines))$OpenCreditLines)
```
Here, interestingly, the medians are equal. Let's see what the means tell us.
```{r}
mean(subset(defaults, !is.na(OpenCreditLines))$OpenCreditLines)

mean(subset(completed, !is.na(OpenCreditLines))$OpenCreditLines)
```
So it seems that the defaulted loans has a longer tail than the completed lonas, and therefore the mean number of open credit lines is further away from the median than for the completed loans. Now let's look at the verified income.
```{r}
ggplot(aes(x = IncomeVerifiable), data = defaults) +
  geom_bar()
```
```{r}
ggplot(aes(x = IncomeVerifiable), data = completed) +
  geom_bar()
```
Interestingly, there doesn't seem to be too much of a difference between defaults and completed loans when it comes to whether or not they have verified income. Finally, we will look at bank card utilization, or, how much the borrower used their credit card.
```{r}
ggplot(aes(x = BankcardUtilization), data = defaults) +
  geom_histogram(binwidth = 0.05) +
  scale_x_continuous(breaks = seq(0, 2, 0.1), limits = c(0, 2))
```
```{r}
ggplot(aes(x = BankcardUtilization), data = completed) +
  geom_histogram(binwidth = 0.05) +
  scale_x_continuous(breaks = seq(0, 2, 0.1), limits = c(0, 2))
```
We can see that for defaulted loans, they appear to use a higher percentage of their available bank card credit. Let's look at medians and means now.
```{r}
mean(subset(defaults, !is.na(BankcardUtilization))$BankcardUtilization)

mean(subset(completed, !is.na(BankcardUtilization))$BankcardUtilization)

median(subset(defaults, !is.na(BankcardUtilization))$BankcardUtilization)

median(subset(completed, !is.na(BankcardUtilization))$BankcardUtilization)
```
So we can see that defaults have both a higher mean and median bank card utilization percentage than completed loans.

Now we have a list of variables that may be useful in our model: the loan rating, the borrower's credit score, stated monthly income, debt-to-income ratio, open lines of credit, and bank card utilization percentage. Some variables that didn't appear as useful were: employment status and verifiable income.

## Analysis

I am going to create new data sets that contain only the variables I care about, so that they are easier to work with.
```{r}
wantedcols <- c('LoanStatus', 'Rating', 'CreditScoreAvg',
                'OpenCreditLines', 'BankcardUtilization',
                'DebtToIncomeRatio', 'StatedMonthlyIncome',
                'BorrowerAPR')

mod_loans <- loans[wantedcols]

```

Because the result of a loan is a binary choice, I am going to attempt to use logarithmic regression to create a model that will give the percent chance a loan will default. To do this I will first convert the loan rating into a numeric scale, one that mirrors Prosper's own numeric rankings.
```{r}
mod_loans$rating.numeric <- ifelse(mod_loans$Rating == 'AA', 7,
                            ifelse(mod_loans$Rating == 'A', 6,
                            ifelse(mod_loans$Rating == 'B', 5,
                            ifelse(mod_loans$Rating == 'C', 4,
                            ifelse(mod_loans$Rating == 'D', 3,
                            ifelse(mod_loans$Rating == 'E', 2,
                            ifelse(mod_loans$Rating == 'HR',1,                                        0)))))))

mod_results <- subset(mod_loans, LoanStatus == 'Completed' |
                                LoanStatus == 'Defaulted')
```
Now I will create a new column that is 0 if the loan is defaulted and 1 if it is completed.
```{r}
mod_results$result <- ifelse(mod_results$LoanStatus == 'Completed', 1, 0)

```